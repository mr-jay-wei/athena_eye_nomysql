# frontend/nginx.conf
# Nginx 配置文件

server {
    # 监听80端口
    listen 80;
    # 默认的网站根目录，我们的Vue静态文件就在这里
    root /usr/share/nginx/html;
    # 默认首页文件
    index index.html;

    # --- API反向代理配置 ---
    # 所有以 /api/ 开头的请求，都转发给后端服务
    location /api/ {
        # proxy_pass 指令是反向代理的核心
        # http://backend:8000 中的 'backend' 是我们在docker-compose.prod.yml中定义的服务名
        # Docker的内部DNS会自动将其解析为后端容器的IP地址
        proxy_pass http://backend:8000;
        
        # --- 以下是反向代理的标准头部设置 ---
        # 将原始请求的Host头部传递给后端
        proxy_set_header Host $host;
        # 将客户端的真实IP地址传递给后端
        proxy_set_header X-Real-IP $remote_addr;
        # 传递代理服务器的IP地址列表
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # 告诉后端是通过https还是http连接的
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Vue Router history 模式配置 ---
    # 这是一个关键配置，用于解决Vue单页应用刷新页面时出现404的问题
    # 它匹配所有不以/api/开头，且不是一个真实存在的文件的请求
    location / {
        # 尝试按顺序查找文件：$uri (请求的URI) -> $uri/ (请求的目录) -> /index.html
        # 如果前两者都找不到，就回退到/index.html，让Vue Router来接管路由
        try_files $uri $uri/ /index.html;
    }
}